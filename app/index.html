<!DOCTYPE html>
<html>
<head>
<script src="js/jquery-3.5.1.js"></script>
<script src="js/mopidy.js"></script>
<script type="text/JavaScript">
const mopidy = new Mopidy();

function pauseResumeButtonText(state) {
    if (state == "paused") {
        $("#pause_resume").text("Resume Playback");
    }
    else {
        $("#pause_resume").text("Pause Playback");
    }
}

// Register handlers for all sort of events
$(document).ready(function() {
    // Initialize some values with the current mopidy state on page load
    mopidy.on("state:online", () => {
        // Initialize the volume input field with the current mixer volume
        mopidy.mixer.getVolume().then(
            (vol) => { $('#volume').val(vol); },
            () => { alert("Error getting volume"); }
        );

        // Initialize the text on the Pause/Resume button with the current state
        mopidy.playback.getState().then(pauseResumeButtonText);
    });

    mopidy.on("event:playbackStateChanged", (args) => {
        pauseResumeButtonText(args.new_state);
    });

    // Handle a Set Volume Button Click
    $("#setvolume").click(() => {
        var vol = parseInt($("#volume").val(), 10);
        vol = Math.min(100, vol);
        vol = Math.max(0, vol);
        mopidy.mixer.setVolume([vol]).then(
            () => { $('#volume').val(vol); },
            () => { alert("Error setting volume!"); }
        );
    });

    // Handle a Pause/Resume Button Click
    $("#pause_resume").click(() => {
        mopidy.playback.getState().then(state => {
            if (state == "paused") {
                mopidy.playback.resume().then(() => {});
            }
            else {
                mopidy.playback.pause().then(() => {});
            }
        });
    });

    // Handle a Read button click
    $("#read").click(() => {
        $.getJSON('/vyvo_api/read/', (data) => {
            $('#uri').val(data['uri']);
        })    
    });

    // Make sure that we read once upon loading the client
    $("#read").click();

    // Handle a Write button click
    $("#write").click(() => {
        var uri = $("#uri").val();
        mopidy.getUriSchemes().then(schemes => {
            var okay = false;
            schemes.forEach(scheme => {
                if(uri.startsWith(scheme + ":")) {
                    okay = true;
                    $.post('/vyvo_api/write/', {"uri": uri});
                    $("#read").click();
                }
            });
            if (!okay) {
                alert("Invalid URI - not written to tag!");
            }
        });
    });
});
</script>
</head>
<body>
<p>
    <h2>Playback Control</h2>
    <p> Volume: <input type="text" id="volume" value="?"><button id="setvolume">Set!</button></p>
    <p><button id="pause_resume">?</button></p>
</p>
<p>
    <h2>Media Control</h2>
    <p>Current RFID URI: <input type="text" id="uri" value=""><button id="read">Read!</button><button id="write">Write!</button></p>
</p>

</body>
</html>
